<?xml version="1.0" ?>
<sdf version='1.7'>

  <!-- Change recordï¼š
  - Reconstructed the model to start from the payload as the parent.
  - Adjusted joint connections so that cables are children of the payload.
  -->

  <model name='flexible_cable'>

  <!-- Color properties -->
  {% set blue_color = "0 0 0.8 1" %}
  {% set red_color = "1 0 0 1" %}
  {% set gray_color = "0.5 0.5 0.5 1" %}

  <!-- Segment Constants -->
  {% set inertia_factor_xy = (1.0/12) * cylinder_mass * (3 * rope_radius**2 + (segment_length/2)**2) %}
  {% set inertia_factor_z = (1.0/2) * cylinder_mass * rope_radius**2 %}

  {% set inertia_load_x = (1.0/12) * payload_mass * (payload_width**2 + payload_height**2) %}
  {% set inertia_load_y = (1.0/12) * payload_mass * (payload_length**2 + payload_height**2) %}
  {% set inertia_load_z = (1.0/12) * payload_mass * (payload_length**2 + payload_width**2) %}

  <!-- base_link initialization -->
  {% set cable_length = segment_length * segment_count %}
  {% set cable_xy = cable_length * math.sin(angle) %}
  {% set cable_z = cable_length * math.cos(angle) %}

  <!-- Elasticity Params -->
  {% set cfm = (stepsize * stiffness) / (stepsize * stiffness + damping) %}
  {% set erp = 1 / (stepsize * stiffness + damping) %}

    <!-- Payload link as the parent link -->
    <link name="payload">
        <pose>
        0 0 
        {{ cable_height - base_length - payload_height / 2 - cable_z}}
        0 -0 0 </pose>
        <inertial>
            <pose>0 0 0 0 -0 0</pose>
            <mass>{{ payload_mass }}</mass>
            <inertia>
              <ixx>{{ inertia_load_x }}</ixx>
              <iyy>{{ inertia_load_y }}</iyy>
              <izz>{{ inertia_load_z }}</izz>
            </inertia>
        </inertial>

        <collision name='payload_collision'>
          <pose>0 0 0 0 -0 0</pose>
          <geometry>
            <box>
              <size>{{ payload_length }} {{ payload_width }} {{ payload_height }}</size>
            </box>
          </geometry>
        </collision>

        <visual name='payload_visual'>
          <pose>0 0 0 0 -0 0</pose>
          <geometry>
            <box>
              <size>{{ payload_length }} {{ payload_width }} {{ payload_height }}</size>
            </box>
          </geometry>
          <material>
          <script>
            <name>Gazebo/CeilingTiled</name>
            <uri>file://media/materials/scripts/gazebo.material</uri>
          </script>
        </material>
        </visual>
      </link>

    {% for cable in range(cable_count) %}
    <!-- Calculate initial positions for the cables based on the number of cables -->
    <joint name="cable_{{ cable+1 }}_endjoint" type="universal">
        <parent>payload</parent>
        <child>cable_{{ cable+1 }}_segment_0_cylinder_1</child>
        <pose>
        {{ math.sin(2*math.pi / cable_count * (cable+1)) * (payload_width/2) }} 
        {{ - math.cos(2*math.pi / cable_count * (cable+1)) * (payload_width/2) }} 
        {{ -payload_height/2 }} 
        0 0 0
        </pose>
        <axis>
          <xyz>1 0 0</xyz>
        </axis>
        <axis2>
          <xyz>0 1 0</xyz>
        </axis2>
    </joint>

    <!-- Generate the first segment LINKED TO payload -->
    <link name='cable_{{ cable+1 }}_segment_0_cylinder_1'>
      <pose relative_to='payload'>
      {{ math.sin(2*math.pi / cable_count * (cable+1)) * (payload_width/2) }} 
      {{ - math.cos(2*math.pi / cable_count * (cable+1)) * (payload_width/2) }} 
      {{ -payload_height/2 - segment_length/4 }} 
      0 -0 0</pose>

      <inertial>
        <mass>{{cylinder_mass}}</mass>
        <inertia>
          <ixx>{{inertia_factor_xy}}</ixx>
          <ixy>0</ixy>
          <ixz>0</ixz>
          <iyy>{{inertia_factor_xy}}</iyy>
          <iyz>0</iyz>
          <izz>{{inertia_factor_z}}</izz>
        </inertia>
      </inertial>

      <collision name='cable_{{ cable+1 }}_segment_0_cylinder_1_collision'>
        <geometry>
          <cylinder>
            <length>{{segment_length/2}}</length>
            <radius>{{rope_radius}}</radius>
          </cylinder>
        </geometry>
        <surface>
          <contact>
            <ode/>
          </contact>
          <friction>
            <ode/>
          </friction>
        </surface>
      </collision>

      <visual name='cable_{{ cable+1 }}_segment_0_cylinder_1_visual'>
        <geometry>
          <cylinder>
            <length>{{segment_length/2}}</length>
            <radius>{{rope_radius}}</radius>
          </cylinder>
        </geometry>
        <material>
          <script>
            <name>Gazebo/Gold</name>
            <uri>file://media/materials/scripts/gazebo.material</uri>
          </script>
        </material>
      </visual>
      <self_collide>0</self_collide>
      <gravity>1</gravity>
    </link>

    <!-- Prismatic joint between the first and second cylinders -->
    <joint name="cable_{{ cable+1 }}_prismatic_segment_0" type="prismatic">
        <parent>cable_{{ cable+1 }}_segment_0_cylinder_1</parent>
        <child>cable_{{ cable+1 }}_segment_0_cylinder_2</child>
        <pose>0 0 0 0 -0 0</pose>

        <axis>
            <xyz>0.0 0.0 -1.0</xyz>
            <limit>
                <effort>-1</effort>
            </limit>
            <dynamics>
              <spring_stiffness>{{stiffness}}</spring_stiffness> 
              <spring_reference>0.0</spring_reference>
              <damping>{{damping}}</damping> 
              <friction>{{friction}}</friction>
            </dynamics>
        </axis>
        <physics>
        <provide_feedback>1</provide_feedback>
        <ode>
          <implicit_spring_damper>1</implicit_spring_damper>
          <cfm_damping>1</cfm_damping>
          <limit>
            <cfm>0</cfm>
            <erp>0.2</erp>
          </limit>
        </ode>
      </physics>
    </joint>

    <!-- Second cylinder of the first segment -->
    <link name='cable_{{ cable+1 }}_segment_0_cylinder_2'>
      <pose relative_to='cable_{{ cable+1 }}_segment_0_cylinder_1'>
      0 0 {{ -segment_length/2 }} 0 -0 0</pose>

      <inertial>
        <mass>{{cylinder_mass}}</mass>
        <inertia>
          <ixx>{{inertia_factor_xy}}</ixx>
          <ixy>0</ixy>
          <ixz>0</ixz>
          <iyy>{{inertia_factor_xy}}</iyy>
          <iyz>0</iyz>
          <izz>{{inertia_factor_z}}</izz>
        </inertia>
      </inertial>

      <collision name='cable_{{ cable+1 }}_segment_0_cylinder_2_collision'>
        <geometry>
          <cylinder>
            <length>{{segment_length/2}}</length>
            <radius>{{rope_radius}}</radius>
          </cylinder>
        </geometry>
        <surface>
          <contact>
            <ode/>
          </contact>
          <friction>
            <ode/>
          </friction>
        </surface>
      </collision>

      <visual name='cable_{{ cable+1 }}_segment_0_cylinder_2_visual'>
        <geometry>
          <cylinder>
            <length>{{segment_length/2}}</length>
            <radius>{{rope_radius}}</radius>
          </cylinder>
        </geometry>
        <material>
          <script>
            <name>Gazebo/Gold</name>
            <uri>file://media/materials/scripts/gazebo.material</uri>
          </script>
        </material>
      </visual>
      <self_collide>0</self_collide>
      <gravity>1</gravity>
    </link>

    {% for segment in range(1, segment_count) %}
    <!-- Universal joint between segments -->
    <joint name="cable_{{ cable+1 }}_segment_{{ segment }}_UNIVERSAL" type="universal">
        <parent>cable_{{ cable+1 }}_segment_{{ segment - 1 }}_cylinder_2</parent>
        <child>cable_{{ cable+1 }}_segment_{{ segment }}_cylinder_1</child>
        <pose>0 0 {{ -segment_length/2 }} 0 0 0</pose>

        <axis>
          <xyz>0 1 0</xyz>
        </axis>
        <axis2>
          <xyz>1 0 0</xyz>
        </axis2>
    </joint>

    <!-- First cylinder of the segment -->
    <link name='cable_{{ cable+1 }}_segment_{{ segment }}_cylinder_1'>
      <pose relative_to='cable_{{ cable+1 }}_segment_{{ segment - 1 }}_cylinder_2'>
      0 0 {{ -segment_length/2 - segment_length/4 }} 0 -0 0</pose>

      <inertial>
        <mass>{{cylinder_mass}}</mass>
        <inertia>
          <ixx>{{inertia_factor_xy}}</ixx>
          <ixy>0</ixy>
          <ixz>0</ixz>
          <iyy>{{inertia_factor_xy}}</iyy>
          <iyz>0</iyz>
          <izz>{{inertia_factor_z}}</izz>
        </inertia>
      </inertial>

      <collision name='cable_{{ cable+1 }}_segment_{{ segment }}_cylinder_1_collision'>
        <geometry>
          <cylinder>
            <length>{{segment_length/2}}</length>
            <radius>{{rope_radius}}</radius>
          </cylinder>
        </geometry>
        <surface>
          <contact>
            <ode/>
          </contact>
          <friction>
            <ode/>
          </friction>
        </surface>
      </collision>

      <visual name='cable_{{ cable+1 }}_segment_{{ segment }}_cylinder_1_visual'>
        <geometry>
          <cylinder>
            <length>{{segment_length/2}}</length>
            <radius>{{rope_radius}}</radius>
          </cylinder>
        </geometry>
        <material>
          <script>
            <name>Gazebo/Gold</name>
            <uri>file://media/materials/scripts/gazebo.material</uri>
          </script>
        </material>
      </visual>
      <self_collide>0</self_collide>
      <gravity>1</gravity>
    </link>

    <!-- Prismatic joint in the segment -->
    <joint name="cable_{{ cable+1 }}_prismatic_segment_{{ segment }}" type="prismatic">
        <parent>cable_{{ cable+1 }}_segment_{{ segment }}_cylinder_1</parent>
        <child>cable_{{ cable+1 }}_segment_{{ segment }}_cylinder_2</child>
        <pose>0 0 0 0 -0 0</pose>

        <axis>
            <xyz>0.0 0.0 -1.0</xyz>
            <limit>
                <effort>-1</effort>
            </limit>
            <dynamics>
              <spring_stiffness>{{stiffness}}</spring_stiffness> 
              <spring_reference>0.0</spring_reference>
              <damping>{{damping}}</damping> 
              <friction>{{friction}}</friction>
            </dynamics>
        </axis>
        <physics>
        <provide_feedback>1</provide_feedback>
        <ode>
          <implicit_spring_damper>1</implicit_spring_damper>
          <cfm_damping>1</cfm_damping>
          <limit>
            <cfm>0</cfm>
            <erp>0.2</erp>
          </limit>
        </ode>
      </physics>
    </joint>

    <!-- Second cylinder of the segment -->
    <link name='cable_{{ cable+1 }}_segment_{{ segment }}_cylinder_2'>
      <pose relative_to='cable_{{ cable+1 }}_segment_{{ segment }}_cylinder_1'>
      0 0 {{ -segment_length/2 }} 0 -0 0</pose>

      <inertial>
        <mass>{{cylinder_mass}}</mass>
        <inertia>
          <ixx>{{inertia_factor_xy}}</ixx>
          <ixy>0</ixy>
          <ixz>0</ixz>
          <iyy>{{inertia_factor_xy}}</iyy>
          <iyz>0</iyz>
          <izz>{{inertia_factor_z}}</izz>
        </inertia>
      </inertial>

      <collision name='cable_{{ cable+1 }}_segment_{{ segment }}_cylinder_2_collision'>
        <geometry>
          <cylinder>
            <length>{{segment_length/2}}</length>
            <radius>{{rope_radius}}</radius>
          </cylinder>
        </geometry>
        <surface>
          <contact>
            <ode/>
          </contact>
          <friction>
            <ode/>
          </friction>
        </surface>
      </collision>

      <visual name='cable_{{ cable+1 }}_segment_{{ segment }}_cylinder_2_visual'>
        <geometry>
          <cylinder>
            <length>{{segment_length/2}}</length>
            <radius>{{rope_radius}}</radius>
          </cylinder>
        </geometry>
        <material>
          <script>
            <name>Gazebo/Gold</name>
            <uri>file://media/materials/scripts/gazebo.material</uri>
          </script>
        </material>
      </visual>
      <self_collide>0</self_collide>
      <gravity>1</gravity>
    </link>
    {% endfor %}

    <!-- Fixed joint to attach the last segment to the world -->
    <joint name='cable_{{ cable+1 }}_fixed_to_world' type='fixed'>
      <parent>cable_{{ cable+1 }}_segment_{{ segment_count-1 }}_cylinder_2</parent>
      <child>world</child>
      <pose relative_to='cable_{{ cable+1 }}_segment_{{ segment_count-1 }}_cylinder_2'>
      0 0 {{ -segment_length/2 }} 0 0 0
      </pose>
    </joint>
    {% endfor %}

    <!-- Plugins and sensors can be adjusted similarly if needed -->

    <self_collide>0</self_collide>

  </model>
  
</sdf>
